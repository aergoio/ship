<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Router.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ship</a> &gt; <a href="index.source.html" class="el_package">ship.build.web</a> &gt; <span class="el_source">Router.java</span></div><h1>Router.java</h1><pre class="source lang-java linenums">/*
 * @copyright defined in LICENSE.txt
 */

package ship.build.web;

import static hera.util.ExceptionUtils.getStackTraceOf;
import static org.slf4j.LoggerFactory.getLogger;

import java.io.IOException;
import java.util.List;
import javax.annotation.PostConstruct;
import javax.inject.Inject;
import org.slf4j.Logger;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.context.request.WebRequest;
import ship.build.web.exception.HttpException;
import ship.build.web.exception.ResourceNotFoundException;
import ship.build.web.model.BuildDetails;
import ship.build.web.model.BuildSummary;
import ship.build.web.model.ContractInput;
import ship.build.web.model.DeploymentResult;
import ship.build.web.model.ExecutionResult;
import ship.build.web.model.QueryResult;
import ship.build.web.model.ServiceError;
import ship.build.web.service.BuildService;
import ship.build.web.service.ContractService;
import ship.build.web.service.LiveUpdateService;

@RestController
@ControllerAdvice
<span class="nc" id="L42">public class Router {</span>

<span class="nc" id="L44">  protected final transient Logger logger = getLogger(getClass());</span>

  @Inject
  protected BuildService buildService;

  @Inject
  protected ContractService contractService;

  @Inject
  protected LiveUpdateService liveUpdateService;

  @PostConstruct
  public void initialize() {
<span class="nc" id="L57">    buildService.addListener(liveUpdateService::notifyChange);</span>
<span class="nc" id="L58">  }</span>

  @GetMapping(&quot;contract&quot;)
  public DeploymentResult getLatestContract() {
<span class="nc" id="L62">    return contractService.getLatestContractInformation();</span>
  }

  @GetMapping(&quot;builds&quot;)
  public List&lt;BuildSummary&gt; getLatestBuilds() {
<span class="nc" id="L67">    return buildService.list(null, 5);</span>
  }

  @GetMapping(&quot;build/{uuid}&quot;)
  public BuildDetails getBuild(@PathVariable(&quot;uuid&quot;) final String buildUuid) {
<span class="nc" id="L72">    return buildService.get(buildUuid).orElseThrow(ResourceNotFoundException::new);</span>
  }

  /**
   * Deploy result of build with {@code buildUuid}.
   *
   * @param buildUuid build uuid
   *
   * @return deployment result
   *
   * @throws Exception Fail to deploy
   */
  @PostMapping(&quot;build/{uuid}/deploy&quot;)
  public DeploymentResult deploy(@PathVariable(&quot;uuid&quot;) final String buildUuid) throws Exception {
<span class="nc" id="L86">    final BuildDetails buildDetails = buildService.get(buildUuid)</span>
<span class="nc" id="L87">        .orElseThrow(() -&gt; new ResourceNotFoundException(buildUuid + &quot; not found&quot;));</span>
<span class="nc" id="L88">    return contractService.deploy(buildDetails);</span>
  }

  @PostMapping(value = &quot;contract/{tx}/{function}&quot;)
  public ExecutionResult execute(
      @PathVariable(&quot;tx&quot;) final String contractTransactionHash,
      @PathVariable(&quot;function&quot;) final String functionName,
      @RequestBody final ContractInput contractInput) throws IOException {
<span class="nc" id="L96">    final String[] arguments = contractInput.getArguments();</span>
<span class="nc" id="L97">    return contractService.execute(contractTransactionHash, functionName, arguments);</span>
  }

  /**
   * Query contract.
   *
   * @param contractTransactionHash transaction hash
   * @param functionName            function'name to call
   * @param arguments               argument for function
   *
   * @return function's result
   *
   * @throws IOException Fail to invoke function
   */
  @GetMapping(value = &quot;contract/{tx}/{function}&quot;)
  public QueryResult query(
      @PathVariable(&quot;tx&quot;) final String contractTransactionHash,
      @PathVariable(&quot;function&quot;) final String functionName,
      @RequestParam(value = &quot;arguments&quot;, required = false) final String[] arguments
  ) throws IOException {
<span class="nc" id="L117">    logger.trace(&quot;Transaction Hash: {}, Function: {}, Arguments: {}&quot;,</span>
        contractTransactionHash, functionName, arguments);
<span class="nc bnc" id="L119" title="All 2 branches missed.">    if (null == arguments) {</span>
<span class="nc" id="L120">      return contractService.query(contractTransactionHash, functionName, new String[0]);</span>
    } else {
<span class="nc" id="L122">      return contractService.query(contractTransactionHash, functionName, arguments);</span>
    }
  }

  @ExceptionHandler(value = { HttpException.class })
  protected ResponseEntity handleHttpException(HttpException ex, WebRequest request) {
<span class="nc" id="L128">    final ServiceError serviceError = new ServiceError(ex.getMessage(), getStackTraceOf(ex));</span>
<span class="nc" id="L129">    return ResponseEntity.status(ex.getStatusCode()).body(serviceError);</span>
  }

  @ExceptionHandler(value = { Throwable.class })
  @ResponseStatus()
  @ResponseBody
  protected Object handleThrowable(Throwable ex, WebRequest request) {
<span class="nc" id="L136">    return new ServiceError(ex.getMessage(), getStackTraceOf(ex));</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>